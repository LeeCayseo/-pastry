<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Webcam Snap Overlay</title>
    <style>
      body { margin: 0; overflow: hidden; }
      canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 0;
      }
      #switchBtn {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 100;
        padding: 30px 25px;
        font-size: 16px;
        background: rgba(255,255,255,0.9);
        border: none;
        border-radius: 8px;
        display: none; /* ëª¨ë°”ì¼ì—ì„œë§Œ ë³´ì´ê²Œ */
      }
    </style>
  </head>
  <body>
    <button id="switchBtn">ğŸ“· ì¹´ë©”ë¼ ì „í™˜</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script>
      let cam;
      let snapshots = [];
      let SNAP_SIZE;
      let isMobileDevice;
      let facingMode = "environment"; // ê¸°ë³¸ í›„ë©´

      function isMobile() {
        return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      }

      function setup() {
        createCanvas(windowWidth, windowHeight);

        isMobileDevice = isMobile();
        SNAP_SIZE = isMobileDevice ? 300 : 200;

        if (isMobileDevice) {
          const btn = document.getElementById("switchBtn");
          btn.style.display = "block";

          // ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            switchCamera();
          });
        }

        startCamera();
      }

      function startCamera() {
        if (cam) {
          cam.remove(); // ì´ì „ ìº  ìŠ¤íŠ¸ë¦¼ ì œê±°
        }

        const constraints = isMobileDevice
          ? { audio: false, video: { facingMode: { exact: facingMode } } }
          : { audio: false, video: true };

        cam = createCapture(constraints, () => console.log("Camera initialized"));
        cam.size(windowWidth, windowHeight);
        cam.hide();
      }

      function switchCamera() {
        facingMode = (facingMode === "user") ? "environment" : "user";
        startCamera(); // ì „í™˜
      }

      function draw() {
        if (isMobileDevice) {
          image(cam, 0, 0, width, height); // ë°˜ì „ ì—†ìŒ
        } else {
          push();
          translate(width, 0);
          scale(-1, 1); // ì¢Œìš° ë°˜ì „
          image(cam, 0, 0, width, height);
          pop();
        }

        for (let snap of snapshots) {
          image(snap.img, snap.x, snap.y, SNAP_SIZE, SNAP_SIZE);

          stroke(255, 255, 0);
          noFill();
          strokeWeight(2);
          rect(snap.x, snap.y, SNAP_SIZE, SNAP_SIZE);

          const labelPadding = 4;
          const line1 = 'ë¹µì´ êµ¬ì›Œì§„ ì‹œê°„:';
          const line2 = snap.timestamp;

          textSize(14);
          textLeading(16);
          let tw = max(textWidth(line1), textWidth(line2));
          let th = 36;

          noStroke();
          fill(255, 255, 0);
          rect(snap.x, snap.y - th, tw + labelPadding * 2, th);

          fill(139, 69, 19);
          textAlign(LEFT, TOP);
          text(line1 + '\n' + line2, snap.x + labelPadding, snap.y - th + 2);
        }
      }

      // ë²„íŠ¼ ì˜ì—­ í´ë¦­ ì²´í¬ í•¨ìˆ˜
      function isOverButton(x, y) {
        const btn = document.getElementById("switchBtn");
        const rect = btn.getBoundingClientRect();
        return (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
      }

      function mousePressed(event) {
        if (isOverButton(event.clientX, event.clientY)) {
          // ë²„íŠ¼ í´ë¦­ ì‹œ ìŠ¤ëƒ…ìƒ· ì°ì§€ ì•ŠìŒ
          return;
        }
        takeSnapshot();
      }

      function touchStarted(event) {
        if (event.touches) {
          for (let i = 0; i < event.touches.length; i++) {
            let t = event.touches[i];
            if (isOverButton(t.clientX, t.clientY)) {
              return false; // ë²„íŠ¼ í„°ì¹˜ ì‹œ ìŠ¤ëƒ…ìƒ· ë§‰ê¸°
            }
          }
        }
        takeSnapshot();
        return false;
      }

      function takeSnapshot() {
        const flippedX = isMobileDevice ? mouseX : width - mouseX;
        const sx = constrain(flippedX - SNAP_SIZE / 2, 0, width - SNAP_SIZE);
        const sy = constrain(mouseY - SNAP_SIZE / 2, 0, height - SNAP_SIZE);
        const raw = cam.get(sx, sy, SNAP_SIZE, SNAP_SIZE);

        let finalImg;

        if (isMobileDevice) {
          finalImg = raw;
        } else {
          let flipped = createImage(SNAP_SIZE, SNAP_SIZE);
          flipped.copy(raw, 0, 0, SNAP_SIZE, SNAP_SIZE, 0, 0, SNAP_SIZE, SNAP_SIZE);
          flipped.loadPixels();
          raw.loadPixels();
          for (let y = 0; y < SNAP_SIZE; y++) {
            for (let x = 0; x < SNAP_SIZE; x++) {
              let i = 4 * (y * SNAP_SIZE + x);
              let j = 4 * (y * SNAP_SIZE + (SNAP_SIZE - 1 - x));
              for (let k = 0; k < 4; k++) {
                flipped.pixels[i + k] = raw.pixels[j + k];
              }
            }
          }
          flipped.updatePixels();
          finalImg = flipped;
        }

        const now = new Date();
        const timestamp = now.getFullYear() + '-' +
                          nf(now.getMonth() + 1, 2) + '-' +
                          nf(now.getDate(), 2) + ' ' +
                          nf(now.getHours(), 2) + ':' +
                          nf(now.getMinutes(), 2) + ':' +
                          nf(now.getSeconds(), 2);

        snapshots.push({
          x: mouseX - SNAP_SIZE / 2,
          y: sy,
          img: finalImg,
          timestamp
        });
      }
    </script>
  </body>
</html>
