<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Webcam Snap Overlay</title>
    <style>
      body { margin: 0; overflow: hidden; }
      canvas { display: block; }
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script>
      let cam;
      let snapshots = [];
      let SNAP_SIZE;

      function isMobile() {
        return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      }

      function setup() {
        createCanvas(windowWidth, windowHeight);
        SNAP_SIZE = isMobile() ? 300 : 100;

        let constraints;

        if (isMobile()) {
          constraints = {
            audio: false,
            video: { facingMode: { exact: "environment" } }
          };
        } else {
          constraints = {
            audio: false,
            video: true
          };
        }

        cam = createCapture(constraints, () => console.log("Camera initialized"));
        cam.size(windowWidth, windowHeight);
        cam.hide();
      }

      function draw() {
        // 캠 영상 좌우 반전해서 출력
        push();
        translate(width, 0);
        scale(-1, 1);
        image(cam, 0, 0, width, height);
        pop();

        // 캡처된 반전 이미지 출력
        for (let snap of snapshots) {
          image(snap.img, snap.x, snap.y, SNAP_SIZE, SNAP_SIZE);
          noFill();
          stroke(255, 0, 255);
          strokeWeight(2);
          rect(snap.x, snap.y, SNAP_SIZE, SNAP_SIZE);
        }
      }

      function mousePressed() {
        takeSnapshot();
      }

      function touchStarted() {
        takeSnapshot();
        return false;
      }

      function takeSnapshot() {
        // 반전된 화면 기준 캡처 좌표
        const flippedX = width - mouseX;
        const sx = constrain(flippedX - SNAP_SIZE / 2, 0, width - SNAP_SIZE);
        const sy = constrain(mouseY - SNAP_SIZE / 2, 0, height - SNAP_SIZE);

        // 원본에서 잘라온 이미지
        const raw = cam.get(sx, sy, SNAP_SIZE, SNAP_SIZE);

        // 좌우 반전 처리
        let flipped = createImage(SNAP_SIZE, SNAP_SIZE);
        flipped.copy(raw, 0, 0, SNAP_SIZE, SNAP_SIZE, 0, 0, SNAP_SIZE, SNAP_SIZE);
        flipped.loadPixels();
        raw.loadPixels();
        for (let y = 0; y < SNAP_SIZE; y++) {
          for (let x = 0; x < SNAP_SIZE; x++) {
            let i = 4 * (y * SNAP_SIZE + x);
            let j = 4 * (y * SNAP_SIZE + (SNAP_SIZE - 1 - x));
            for (let k = 0; k < 4; k++) {
              flipped.pixels[i + k] = raw.pixels[j + k];
            }
          }
        }
        flipped.updatePixels();

        // 현재 보이는 위치 기준으로 출력
        snapshots.push({ x: mouseX - SNAP_SIZE / 2, y: sy, img: flipped });
      }
    </script>
  </body>
</html>
